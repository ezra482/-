<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bible Reader â€” åœ£ç»é˜…è¯»</title>
<style>
  :root{
    --bg:#fbfbfd; --card:#fff; --accent:#bfa25b; --muted:#6b7280; --text:#0f172a;
  }
  body.dark{--bg:#071020;--card:#071428;--accent:#f6d48b;--muted:#9aa6b2;--text:#e6eef6}
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, "Noto Sans SC", "Segoe UI", system-ui, Arial;
    background:linear-gradient(180deg,var(--bg),#f1f5f9);color:var(--text);min-height:100vh;
    display:flex;flex-direction:column;
  }
  header{
    background:linear-gradient(90deg,var(--card),#fff);padding:12px 16px;display:flex;align-items:center;gap:12px;
    border-bottom:1px solid #e6e9ef;position:sticky;top:0;z-index:20;
  }
  .brand{display:flex;flex-direction:column}
  .title{font-family: "Times New Roman", serif;font-size:18px;margin:0}
  .subtitle{font-size:12px;color:var(--muted);margin:0}
  .controls{margin-left:auto;display:flex;gap:8px;align-items:center}
  select,input[type=search]{padding:8px;border-radius:8px;border:1px solid #d1d5db;background:transparent}
  button{background:var(--accent);color:#04202b;border:none;padding:8px 10px;border-radius:8px;cursor:pointer}
  button.ghost{background:transparent;border:1px solid rgba(0,0,0,0.06)}
  main{display:flex;gap:20px;padding:18px;flex:1;align-items:flex-start}
  .sidebar{width:280px;max-height:calc(100vh - 120px);overflow:auto;padding:12px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(2,6,23,0.06)}
  .reader{flex:1;max-width:980px;min-width:280px;overflow:auto}
  .chapterHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .chapterTitle{font-size:18px;font-weight:700}
  .verse{padding:10px;border-radius:8px;margin-bottom:10px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.4));box-shadow:0 1px 0 rgba(0,0,0,0.03)}
  .verse .cn{font-size:17px;margin-bottom:6px}
  .verse .en{font-size:14px;color:var(--muted)}
  .verse .meta{margin-top:8px;display:flex;gap:8px;align-items:center}
  .note{width:100%;padding:8px;border-radius:8px;border:1px solid #e6eef6;background:transparent}
  .fav{cursor:pointer;font-size:18px;color:var(--muted)}
  .fav.active{color:#ef4444}
  .small{font-size:13px;color:var(--muted)}
  .favoritesList{margin-top:12px}
  .favItem{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,#fff,#fbfbfb);display:flex;justify-content:space-between;align-items:center}
  footer{padding:12px;text-align:center;color:var(--muted);font-size:13px}
  .searchResults{max-height:320px;overflow:auto}
  @media(max-width:900px){
    main{flex-direction:column;padding:12px}
    .sidebar{width:100%;order:2}
    .reader{order:1}
  }
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="title">ğŸ“– Bible Reader</div>
    <div class="subtitle">ä¸­è‹±æ–‡å¯¹ç…§ Â· å’Œåˆæœ¬ & KJV</div>
  </div>

  <div class="controls">
    <select id="bookSelect" title="é€‰æ‹©ä¹¦å·"></select>
    <select id="chapterSelect" title="é€‰æ‹©ç« "></select>
    <button id="prevChap" title="ä¸Šä¸€ç« ">â—€</button>
    <button id="nextChap" title="ä¸‹ä¸€ç« ">â–¶</button>

    <input id="searchInput" type="search" placeholder="æœç´¢å…³é”®å­—æˆ–è¾“å…¥â€œçº¦ç¿° 3:16â€" />
    <button id="searchBtn">æœç´¢</button>

    <select id="langMode" title="æ˜¾ç¤ºæ¨¡å¼">
      <option value="bilingual">åŒè¯­</option>
      <option value="zh">ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>

    <button id="favoritesBtn" title="æˆ‘çš„æ”¶è—">â¤ï¸ æ”¶è—</button>
    <button id="settingsBtn" title="è®¾ç½®">âš™ï¸</button>
  </div>
</header>

<main>
  <aside class="sidebar">
    <div><strong>å¿«é€Ÿå¯¼èˆª</strong></div>
    <div class="small" style="margin-top:8px">ä¹¦å· / ç« ï¼ˆç‚¹å‡»è¿›å…¥ï¼‰</div>
    <div id="toc" style="margin-top:10px"></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff" />

    <div><strong>æ”¶è—</strong></div>
    <div id="favorites" class="favoritesList small"></div>

    <hr style="margin:12px 0;border:none;border-top:1px solid #eef2ff" />

    <div><strong>æœç´¢ç»“æœ</strong></div>
    <div id="searchResults" class="searchResults small"></div>
  </aside>

  <section class="reader">
    <div class="chapterHeader">
      <div>
        <div class="chapterTitle" id="chapterTitle">â€” åŠ è½½ç« èŠ‚ â€”</div>
        <div class="small" id="chapterSub"></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <label class="small">æœ—è¯»è¯­é€Ÿ</label>
        <input id="ttsSpeed" type="range" min="0.6" max="1.8" step="0.1" value="1" style="width:120px" />
        <button id="readBtn">ğŸ”Š æœ—è¯»æœ¬ç« </button>
        <button id="playVerseBtn">ğŸ”ˆ æœ—è¯»æ‰€é€‰èŠ‚</button>
      </div>
    </div>

    <div id="versesContainer"></div>

    <div class="note-box" style="margin-top:20px">
      <div class="small">æˆ‘çš„ç¬”è®°ï¼ˆä¿å­˜åˆ°æœ¬åœ°ï¼‰ï¼š</div>
      <textarea id="globalNote" placeholder="å†™ä¸‹ä½ çš„é»˜æƒ³/ç¬”è®°..." style="width:100%;height:120px;margin-top:8px;padding:8px;border-radius:8px"></textarea>
      <div style="margin-top:8px">
        <button id="saveGlobalNote">ä¿å­˜ç¬”è®°</button>
        <button id="clearGlobalNote" style="background:#ef4444;color:#fff">æ¸…é™¤ç¬”è®°</button>
      </div>
    </div>
  </section>
</main>

<footer>Â© 2025 Bible Reader Â· ä¸­è‹±å¯¹ç…§ Â· ç¦»çº¿/åœ¨çº¿å‡å¯ Â· æ•°æ®å¯æ‰©å±•</footer>

<script>
/*
  bible.html åŠŸèƒ½è¯´æ˜ï¼ˆå·²å®ç°ï¼‰ï¼š
  - æ”¯æŒåŠ è½½å¤–éƒ¨ data/bible-data.jsonï¼ˆè‹¥å­˜åœ¨åˆ™ç”¨ä¹‹ï¼‰
  - å†…ç½®å°é‡ç¤ºä¾‹æ–‡æœ¬ç”¨äºæ¼”ç¤º
  - æŒ‰å·ç« æµè§ˆã€ä¸Š/ä¸‹ä¸€ç« 
  - æœç´¢å…³é”®å­—ä¸ä¹¦å ç« :èŠ‚ï¼ˆç®€ä½“/è‹±æ–‡ä¹¦åéœ€åŒ¹é…ï¼‰
  - æ”¶è—å•èŠ‚å¹¶åœ¨ä¾§è¾¹æ å±•ç¤º
  - æ¯èŠ‚ç¬”è®°å’Œå…¨å±€ç¬”è®°ä¿å­˜åˆ° localStorage
  - æœ—è¯»ä½¿ç”¨ Web Speech APIï¼ˆç³»ç»Ÿè¯­éŸ³ï¼‰ï¼Œå¯è°ƒé€Ÿ
  - è®¾ç½®å°†è¯»å– localStorage ä¸­çš„ settingsï¼ˆç”± settings.html å†™å…¥ï¼‰
*/

/* ----------------- å†…ç½®ç¤ºä¾‹æ•°æ®ï¼ˆè‹¥æ”¾å…¥å®Œæ•´dataæ–‡ä»¶ä¼šè¢«è¦†ç›–ï¼‰ ----------------- */
let BIBLE_DATA = {
  "Genesis": {
    "name_cn": "åˆ›ä¸–è®°",
    "chapters": {
      "1": [
        { "v":1, "zh":"èµ·åˆç¥åˆ›é€ å¤©åœ°ã€‚", "en":"In the beginning God created the heaven and the earth." },
        { "v":2, "zh":"åœ°æ˜¯ç©ºè™šæ··æ²Œï¼Œæ¸Šé¢é»‘æš—ï¼›ç¥çš„çµè¿è¡Œåœ¨æ°´é¢ä¸Šã€‚", "en":"And the earth was without form, and void; and darkness was upon the face of the deep." },
        { "v":3, "zh":"ç¥è¯´ï¼šã€Œè¦æœ‰å…‰ã€ï¼Œå°±æœ‰äº†å…‰ã€‚", "en":"And God said, Let there be light: and there was light." }
      ]
    }
  },
  "John": {
    "name_cn": "çº¦ç¿°ç¦éŸ³",
    "chapters": {
      "3": [
        { "v":16, "zh":"ç¥çˆ±ä¸–äººï¼Œç”šè‡³å°†ä»–çš„ç‹¬ç”Ÿå­èµç»™ä»–ä»¬ï¼Œå«ä¸€åˆ‡ä¿¡ä»–çš„ï¼Œä¸è‡³ç­äº¡ï¼Œåå¾—æ°¸ç”Ÿã€‚", "en":"For God so loved the world, that he gave his only begotten Son, that whosoever believeth in him should not perish, but have everlasting life."}
      ]
    }
  }
};

/* ----------------- å°å·¥å…· & DOM ----------------- */
const bookSelect = document.getElementById('bookSelect');
const chapterSelect = document.getElementById('chapterSelect');
const toc = document.getElementById('toc');
const versesContainer = document.getElementById('versesContainer');
const chapterTitle = document.getElementById('chapterTitle');
const chapterSub = document.getElementById('chapterSub');
const searchInput = document.getElementById('searchInput');
const searchBtn = document.getElementById('searchBtn');
const favoritesDiv = document.getElementById('favorites');
const searchResults = document.getElementById('searchResults');
const langMode = document.getElementById('langMode');
const ttsSpeed = document.getElementById('ttsSpeed');

let currentBook = null;
let currentChapter = null;
let selectedVerseId = null; // "Book|Chap|V"
let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
let verseNotes = JSON.parse(localStorage.getItem('verseNotes') || '{}');
let globalNote = localStorage.getItem('globalNote') || '';
document.getElementById('globalNote').value = globalNote;

/* ----------------- è¯»å–è®¾ç½®ï¼ˆå¦‚æœæœ‰ settings.html å†™å…¥ï¼‰ ----------------- */
const SETTINGS = JSON.parse(localStorage.getItem('settings') || '{}');
if(SETTINGS.theme === 'dark') document.body.classList.add('dark');
if(SETTINGS.language) langMode.value = (SETTINGS.language === 'both' ? 'bilingual' : (SETTINGS.language === 'zh' ? 'zh' : 'en'));
if(SETTINGS.speed) ttsSpeed.value = SETTINGS.speed;

/* ----------------- å°è¯•åŠ è½½å¤–éƒ¨å®Œæ•´æ•°æ® ----------------- */
async function tryLoadExternalData(){
  try{
    const res = await fetch('data/bible-data.json', {cache: "no-cache"});
    if(!res.ok) throw new Error('no external data');
    const json = await res.json();
    // æœŸæœ›ç»“æ„ï¼š { "Genesis": { "name_cn":"åˆ›ä¸–è®°", "chapters": {"1":[{v:1,zh:"",en:""}] } } }
    BIBLE_DATA = json;
    populateBookList();
  }catch(e){
    // ä½¿ç”¨å†…ç½®ç¤ºä¾‹
    console.log('ä½¿ç”¨å†…ç½®ç¤ºä¾‹æ•°æ®ï¼›å¤–éƒ¨ bible-data.json æœªæ‰¾åˆ°æˆ–åŠ è½½å¤±è´¥ã€‚', e);
    populateBookList();
  }
}

/* ----------------- å¡«å……ä¹¦å·ä¸ç›®å½• ----------------- */
function populateBookList(){
  bookSelect.innerHTML = '';
  for(const bookKey of Object.keys(BIBLE_DATA)){
    const opt = document.createElement('option');
    opt.value = bookKey;
    opt.text = `${BIBLE_DATA[bookKey].name_cn} Â· ${bookKey}`;
    bookSelect.appendChild(opt);
  }
  // set default
  currentBook = bookSelect.value;
  populateChapterList();
  populateTOC();
}

function populateChapterList(){
  const chapters = Object.keys(BIBLE_DATA[currentBook].chapters).sort((a,b)=>Number(a)-Number(b));
  chapterSelect.innerHTML = '';
  for(const c of chapters){
    const o = document.createElement('option');
    o.value = c;
    o.textContent = `ç¬¬ ${c} ç« `;
    chapterSelect.appendChild(o);
  }
  currentChapter = chapterSelect.value;
  renderChapter();
}

function populateTOC(){
  toc.innerHTML = '';
  for(const b of Object.keys(BIBLE_DATA)){
    const div = document.createElement('div');
    div.style.marginBottom = '8px';
    const title = document.createElement('div');
    title.textContent = `${BIBLE_DATA[b].name_cn} Â· ${b}`;
    title.style.fontWeight = 700; title.style.cursor = 'pointer';
    title.onclick = ()=>{ bookSelect.value = b; currentBook = b; populateChapterList(); };
    div.appendChild(title);
    // small chapter list
    const chList = document.createElement('div');
    chList.style.marginTop = '6px';
    chList.style.display = 'flex'; chList.style.flexWrap = 'wrap'; chList.style.gap = '6px';
    for(const c of Object.keys(BIBLE_DATA[b].chapters)){
      const btn = document.createElement('button');
      btn.className = 'ghost';
      btn.style.padding = '6px 8px';
      btn.textContent = c;
      btn.onclick = ()=>{ bookSelect.value = b; currentBook = b; populateChapterList(); chapterSelect.value = c; currentChapter = c; renderChapter(); };
      chList.appendChild(btn);
    }
    div.appendChild(chList);
    toc.appendChild(div);
  }
}

/* ----------------- æ¸²æŸ“ç« èŠ‚ ----------------- */
function renderChapter(){
  if(!currentBook || !currentChapter) return;
  const data = BIBLE_DATA[currentBook].chapters[currentChapter];
  chapterTitle.textContent = `${BIBLE_DATA[currentBook].name_cn} Â· ${currentBook} ${currentChapter}`;
  chapterSub.textContent = `æ˜¾ç¤ºï¼š${langMode.options[langMode.selectedIndex].text}`;
  versesContainer.innerHTML = '';
  data.forEach(v=>{
    const id = `${currentBook}|${currentChapter}|${v.v}`;
    const div = document.createElement('div');
    div.className = 'verse';
    div.id = id;
    div.innerHTML = `<div><strong>${v.v}.</strong></div>
      <div class="cn">${v.zh}</div>
      <div class="en">${v.en}</div>
      <div class="meta small">
        <span class="fav ${favorites.includes(id)?'active':''}" data-id="${id}" onclick="toggleFav(event)">â˜†</span>
        <button onclick="selectVerse('${id}')">é€‰æ‹©</button>
        <span style="margin-left:8px;color:var(--muted)">ç¬”è®°ï¼š</span>
        <input class="note" data-id="${id}" placeholder="ä¸ºæ­¤èŠ‚å†™ä¸‹ç¬”è®°..." value="${verseNotes[id]||''}" onblur="saveVerseNote(this)" />
      </div>`;
    versesContainer.appendChild(div);
  });
  applyLangMode();
  // store current position
  localStorage.setItem('lastLocation', JSON.stringify({book: currentBook, chapter: currentChapter}));
}

/* ----------------- è¯­è¨€æ¨¡å¼åº”ç”¨ ----------------- */
function applyLangMode(){
  const mode = langMode.value;
  document.querySelectorAll('.cn').forEach(el=>el.style.display = (mode==='en')?'none':'block');
  document.querySelectorAll('.en').forEach(el=>el.style.display = (mode==='zh')?'none':'block');
}

/* ----------------- ä¸Š/ä¸‹ä¸€ç«  ----------------- */
function gotoNextChapter(delta){
  const chapters = Object.keys(BIBLE_DATA[currentBook].chapters).sort((a,b)=>Number(a)-Number(b));
  let idx = chapters.indexOf(String(currentChapter));
  idx += delta;
  if(idx < 0){
    // å‰ä¸€æœ¬ä¹¦æœ€åç« 
    const books = Object.keys(BIBLE_DATA);
    let bidx = books.indexOf(currentBook);
    if(bidx > 0){
      const prevBook = books[bidx-1];
      const chs = Object.keys(BIBLE_DATA[prevBook].chapters).sort((a,b)=>Number(a)-Number(b));
      currentBook = prevBook;
      bookSelect.value = currentBook;
      populateChapterList();
      chapterSelect.value = chs[chs.length-1];
      currentChapter = chapterSelect.value;
      renderChapter();
    } else { alert('å·²ç»æ˜¯ç¬¬ä¸€ç« '); }
    return;
  }
  if(idx >= chapters.length){
    // ä¸‹ä¸€æœ¬ä¹¦ç¬¬ä¸€ç« 
    const books = Object.keys(BIBLE_DATA);
    let bidx = books.indexOf(currentBook);
    if(bidx < books.length-1){
      const nextBook = books[bidx+1];
      currentBook = nextBook;
      bookSelect.value = currentBook;
      populateChapterList();
      chapterSelect.value = Object.keys(BIBLE_DATA[nextBook].chapters).sort((a,b)=>Number(a)-Number(b))[0];
      currentChapter = chapterSelect.value;
      renderChapter();
    } else { alert('å·²ç»æ˜¯æœ€åä¸€ç« '); }
    return;
  }
  chapterSelect.value = chapters[idx];
  currentChapter = chapterSelect.value;
  renderChapter();
}

/* ----------------- æ”¶è—åŠŸèƒ½ ----------------- */
function toggleFav(e){
  e.stopPropagation();
  const id = e.currentTarget.dataset.id;
  const idx = favorites.indexOf(id);
  if(idx === -1) { favorites.push(id); e.currentTarget.classList.add('active'); }
  else { favorites.splice(idx,1); e.currentTarget.classList.remove('active'); }
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderFavorites();
}
function renderFavorites(){
  favoritesDiv.innerHTML = '';
  if(favorites.length === 0){ favoritesDiv.innerHTML = '<div class="small">å°šæ— æ”¶è—</div>'; return; }
  favorites.forEach(fid=>{
    const [bk,ch,v] = fid.split('|');
    const text = (BIBLE_DATA[bk] && BIBLE_DATA[bk].chapters[ch] && BIBLE_DATA[bk].chapters[ch].find(x=>x.v==v)) || null;
    const title = text ? `${BIBLE_DATA[bk].name_cn} ${ch}:${v} â€” ${text.zh.slice(0,36)}...` : fid;
    const row = document.createElement('div');
    row.className = 'favItem';
    row.innerHTML = `<div style="flex:1">${title}</div><div><button onclick="openFav('${fid}')">æ‰“å¼€</button> <button onclick="removeFav('${fid')">åˆ é™¤</button></div>`;
    favoritesDiv.appendChild(row);
  });
}
function openFav(id){
  const [bk,ch,v] = id.split('|');
  bookSelect.value = bk; currentBook = bk;
  populateChapterList();
  chapterSelect.value = ch; currentChapter = ch;
  renderChapter();
  setTimeout(()=>{ document.getElementById(id).scrollIntoView({behavior:'smooth', block:'center'}) }, 200);
}
function removeFav(fid){
  favorites = favorites.filter(x=>x!==fid);
  localStorage.setItem('favorites', JSON.stringify(favorites));
  renderFavorites();
}

/* ----------------- ç¬”è®°ä¿å­˜ ----------------- */
function saveVerseNote(input){
  const id = input.dataset.id;
  const val = input.value.trim();
  if(val) verseNotes[id] = val;
  else delete verseNotes[id];
  localStorage.setItem('verseNotes', JSON.stringify(verseNotes));
}
document.getElementById('saveGlobalNote').addEventListener('click', ()=>{
  localStorage.setItem('globalNote', document.getElementById('globalNote').value);
  alert('å…¨å±€ç¬”è®°å·²ä¿å­˜');
});
document.getElementById('clearGlobalNote').addEventListener('click', ()=>{
  if(confirm('ç¡®å®šè¦æ¸…é™¤å…¨å±€ç¬”è®°ï¼Ÿ')){ document.getElementById('globalNote').value=''; localStorage.removeItem('globalNote'); }
});

/* ----------------- æœ—è¯»åŠŸèƒ½ï¼ˆç« èŠ‚/èŠ‚ï¼‰ ----------------- */
function speakText(text, lang='zh-CN'){
  if(!window.speechSynthesis) { alert('å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³åˆæˆ'); return; }
  window.speechSynthesis.cancel();
  const u = new SpeechSynthesisUtterance(text);
  u.lang = lang;
  u.rate = parseFloat(ttsSpeed.value) || 1;
  // é€‰æ‹©è¾ƒåˆé€‚å£°éŸ³ï¼ˆå°½é‡å¥³å£°/è‡ªç„¶ï¼‰
  const voices = window.speechSynthesis.getVoices();
  if(voices && voices.length){
    // prefer same language voice
    let v = voices.find(x => x.lang && x.lang.toLowerCase().startsWith(lang.split('-')[0]));
    if(!v) v = voices[0];
    if(v) u.voice = v;
  }
  window.speechSynthesis.speak(u);
}

document.getElementById('readBtn').addEventListener('click', ()=>{
  // æœ—è¯»æœ¬ç« ï¼ˆæ‹¼æ¥ä¸­æ–‡+è‹±æ–‡æˆ–æ ¹æ®æ¨¡å¼ï¼‰
  const mode = langMode.value;
  const data = BIBLE_DATA[currentBook].chapters[currentChapter];
  let text = '';
  data.forEach(v=> {
    if(mode === 'zh') text += `${v.v}. ${v.zh}ã€‚ `;
    else if(mode === 'en') text += `${v.v}. ${v.en}. `;
    else text += `${v.v}. ${v.zh}ã€‚ ${v.en}. `;
  });
  const lang = (mode==='en') ? 'en-US' : 'zh-CN';
  speakText(text, lang);
});

document.getElementById('playVerseBtn').addEventListener('click', ()=>{
  if(!selectedVerseId){ alert('è¯·å…ˆç‚¹å‡»æŸä¸€èŠ‚çš„â€œé€‰æ‹©â€æŒ‰é’®'); return; }
  const [bk,ch,v] = selectedVerseId.split('|');
  const item = BIBLE_DATA[bk].chapters[ch].find(x=>x.v==v);
  const mode = langMode.value;
  let text = '';
  if(mode === 'zh') text = `${v}. ${item.zh}`;
  else if(mode === 'en') text = `${v}. ${item.en}`;
  else text = `${v}. ${item.zh}. ${item.en}`;
  const lang = (mode==='en') ? 'en-US' : 'zh-CN';
  speakText(text, lang);
});

/* ----------------- é€‰æ‹©èŠ‚ ----------------- */
function selectVerse(id){
  selectedVerseId = id;
  // highlight
  document.querySelectorAll('.verse').forEach(d=>d.style.boxShadow='none');
  const el = document.getElementById(id);
  if(el) el.style.boxShadow = '0 6px 22px rgba(66,153,225,0.12)';
  // scroll
  el.scrollIntoView({behavior:'smooth', block:'center'});
}

/* ----------------- æœç´¢åŠŸèƒ½ ----------------- */
function searchVerse(){
  const q = searchInput.value.trim();
  if(!q) return alert('è¯·è¾“å…¥å…³é”®è¯æˆ–ç»æ–‡å¼•ç”¨ï¼Œä¾‹å¦‚ï¼šçº¦ç¿° 3:16 æˆ– love');
  searchResults.innerHTML = '';
  // å°è¯•è§£æ ä¹¦å ç« :èŠ‚
  const refMatch = q.match(/([\u4e00-\u9fa5A-Za-z]+)\s*(\d+)\s*[:ï¼š]\s*(\d+)/);
  if(refMatch){
    // ç®€å•æŸ¥æ‰¾ï¼šä¹¦åå¯èƒ½ä¸ºä¸­æ–‡æˆ–è‹±æ–‡ä¹¦å·ç®€ç§°
    const name = refMatch[1];
    const chap = refMatch[2];
    const verseNum = refMatch[3];
    // å°è¯•åŒ¹é…ä¹¦å
    let matchedBook = null;
    for(const bk of Object.keys(BIBLE_DATA)){
      if(BIBLE_DATA[bk].name_cn === name || bk.toLowerCase() === name.toLowerCase()) { matchedBook = bk; break; }
    }
    if(matchedBook && BIBLE_DATA[matchedBook].chapters[chap]){
      const item = BIBLE_DATA[matchedBook].chapters[chap].find(x=>String(x.v)===String(verseNum));
      if(item){
        const el = document.createElement('div');
        el.className='verse';
        el.innerHTML = `<div><strong>${matchedBook} ${chap}:${verseNum}</strong></div><div class="cn">${item.zh}</div><div class="en">${item.en}</div>`;
        searchResults.appendChild(el);
        return;
      }
    }
  }
  // æ™®é€šå…³é”®å­—æœç´¢ï¼ˆä¸­æ–‡æˆ–è‹±æ–‡ï¼‰
  const qLower = q.toLowerCase();
  for(const bk of Object.keys(BIBLE_DATA)){
    for(const ch of Object.keys(BIBLE_DATA[bk].chapters)){
      for(const verse of BIBLE_DATA[bk].chapters[ch]){
        if(verse.zh.includes(q) || (verse.en && verse.en.toLowerCase().includes(qLower))){
          const el = document.createElement('div');
          el.className='verse';
          el.innerHTML = `<div><strong>${BIBLE_DATA[bk].name_cn} ${ch}:${verse.v}</strong></div><div class="cn">${verse.zh}</div><div class="en">${verse.en}</div>`;
          searchResults.appendChild(el);
        }
      }
    }
  }
  if(searchResults.children.length===0) searchResults.innerHTML = '<div class="small">æœªæ‰¾åˆ°åŒ¹é…ç»“æœ</div>';
}

/* ----------------- äº‹ä»¶ç»‘å®š & åˆå§‹åŒ– ----------------- */
document.getElementById('searchBtn').addEventListener('click', searchVerse);
bookSelect.addEventListener('change', ()=>{ currentBook = bookSelect.value; populateChapterList(); });
chapterSelect.addEventListener('change', ()=>{ currentChapter = chapterSelect.value; renderChapter(); });
document.getElementById('prevChap').addEventListener('click', ()=> gotoNextChapter(-1));
document.getElementById('nextChap').addEventListener('click', ()=> gotoNextChapter(1));
document.getElementById('favoritesBtn').addEventListener('click', ()=> {
  if(favorites.length===0) alert('æ²¡æœ‰æ”¶è—'); else {
    // å±•ç¤ºä¾§æ æ”¶è—ï¼šè‡ªåŠ¨æ»šåŠ¨åˆ°favorites
    favoritesDiv.scrollIntoView({behavior:'smooth', block:'center'});
  }
});
document.getElementById('settingsBtn').addEventListener('click', ()=> { window.location.href = 'settings.html'; });
document.getElementById('langMode').addEventListener('change', applyLangMode);

/* ä¿å­˜/åŠ è½½ä¸Šæ¬¡ä½ç½® */
function loadLastLocation(){
  const last = JSON.parse(localStorage.getItem('lastLocation') || 'null');
  if(last && BIBLE_DATA[last.book] && BIBLE_DATA[last.book].chapters[last.chapter]){
    bookSelect.value = last.book; currentBook = last.book;
    populateChapterList();
    chapterSelect.value = last.chapter; currentChapter = last.chapter;
    renderChapter();
  }
}

/* åŠ è½½ favorites & notes UI */
renderFavorites();

/* å°è¯•åŠ è½½å¤–éƒ¨æ•°æ®ï¼Œç„¶ååˆå§‹åŒ– */
tryLoadExternalData().then(()=> {
  // after data loaded
  // populateBookList called in tryLoadExternalData
  setTimeout(loadLastLocation, 200);
});

/* expose some functions for inline handlers */
window.toggleFav = toggleFav;
window.selectVerse = selectVerse;
window.saveVerseNote = function(input){ saveVerseNote(input); };
window.openFav = openFav;
</script>
</body>
</html>
